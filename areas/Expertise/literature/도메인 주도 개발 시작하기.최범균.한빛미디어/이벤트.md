### 생성 날짜: 2024-07-10T18:45
### 주제: 이벤트
---
### 본문:
비즈니스 로직을 수행하다보면 순서에 맞게 진행되어야하는 로직이 존재한다.
1. 구매 취소
2. 환불
3. 환불 완료 메시지 전송 or 이메일 전송

이런 기능을 구현하기 위해 도메인 내부에 service를 파라미터로 넘기면 다음과 같은 문제를 발생시킨다.
1. 외부 서비스가 정상이 아닐 경우 트랜잭션 처리를 어떻게 해야 할지 애매하다.
	1. 환불 중에 예외가 발생하면 환불과 구매 취소 모두 롤백되어야하는가?
2. 외부 서비스의 성능에 따라 전체 과정에 문제가 발생한다.
	1. 외부 서비스 실행 시에 1분이 소요된다고 하면 함수 하나 처리하는데 1분이 늘어난다.
3. 주문 로직과 결제 로직 등이 섞여 설계상의 문제를 야기할 수 있다.
	1. 주문 도메인인데 결제, 환불, 이메일 전송까지 거대한 도메인 로직이 뒤죽박죽 섞을 수 있다.

3번 문제는 바운디드 컨텍스트(=msa로 전환해야하는 단위) 사이의 강결합을 만들어낸다.

이때, 비동기 이벤트를 활용하면 문제를 해결할 수 있다.
- 문제: 바운디드 컨텍스트 간의 강결합

이벤트를 도입하려면 다음 4가지 항목을 구현해야한다.
- 이벤트 정보 (message)
- 이벤트 생성 주체 (domain object)
- 이벤트 디스패처 (publisher)
- 이벤트 핸들러 (subscriber)

스프링에서는 EventListener를 통해 간편하게 subscriber를 구현할 수 있다.
Q: 이벤트 메시지에는 id만 존재하는 것이 좋은지 아니면 필요한 모든 데이터를 넣는 것이 좋은지?

구현 내용에서는 Events object를 만드는 것만 보면 될 것 같다.p.313~315

동기 이벤트를 처리하는 과정에서 예외가 발생하면 트랜잭션은 어떻게 관리할 것인지와 같은 문제가 발생할 수 있는데.
- 이때는 반드시 롤백을 해야하는 것인지 고민하는 것이 선행되면 좋다.

비동기 이벤트를 사용할 수도 있는데. 비동기 이벤트를 사용하고 싶다면 Async 어노테이션을 활용하면 된다. Async 어노테이션은 다른 쓰레드에서 일을 처리하도록 변경하기 때문에 JPA를 활용하고 있다면 그 관리되는 곳이 잘 이전되지 않을 수 있다. (영속성 컨텍스트!)

메시징이나 이벤트 저장소를 이용하여 이벤트 비동기 처리를 구현할 수 있고,
- 이벤트 재처리 방법, 모든 이벤트 다시 소비 방법 등을 고려해보면 좋다. kafka의 컨슈머 그룹이 좋은 예제?

이벤트를 적용할 때 TransactionalEventListener 어노테이션을 활용하면 트랜잭션 커밋이 성공한 후에 이벤트를 발행하기 때문에 트랜잭션 처리 과정에서 예외가 발생하는 경우는 생각하지 않아도 된다.


---
### 참고문헌
- 
---
### 연결문서
- 

