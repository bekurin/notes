### 생성 날짜: 2024-04-12T21:08
### 주제: 외부 서비스와 쿠버네티스 통합
---
### 본문:

## 셀렉터가 없는 서비스로 안정적인 IP 주소 사용

> 셀렉터가 없는 쿠버네티스 서비스를 생성하면 서비스와 일치하는 파드가 없으므로 로드 밸런싱이 수행되지 않습니다. p.236

selector가 없다면 service는 요청을 받을 수 있는 candidate pod 정보를 알 수 없기 때문에 로드 밸런싱이 수행되지 않고, 이와 더불어 selector가 없다면 endpoints 리소스도 생성되지 않는다.

- endpoint: pod 이름과 ip 주소를 맵핑한 정보를 갖고 있는 리소스
- selector: candidate pod을 namespace 기반으로 추론할 수 있는 리소스
- service: candidate pod에 어떻게 요청을 적절하게 흘려보낼지 결정하는 리소스

위와 저자가 말한 것처럼 셀렉터가 없는 경우 사용자 정의로 endpoints 리소스를 만들어서 셀렉터가 없는 서비스를 만들 수 있고, 이는 서비스와 파드가 1 대 1 맵핑이 되는 형태로 구현된다.

## 안정적인 DNS 이름을 위한 CNAME 기반 서비스

| No  | name      | name or ip |
| --- | --------- | ---------- |
| 1   | test.com  | test2.com  |
| 2   | test2.com | test3.com  |
| 3   | test3.com | 24.1.2.3   |
CNAME을 사용하면 DNS 관리 복잡도는 높일 수 있지만 아래와 같이 쿠버네티스에서 관리하는 url 컨밴션을 지킬 수 있습니다.

| No. | external service url | internal service url                  |
| --- | -------------------- | ------------------------------------- |
| 1   | aws.database.com     | <service_name>.<namespace.>.svc.local |
| 2   | gcp.cache.com        | <service_name>.<namespace.>.svc.local |

> 코어 DNS 서버 ... 이 서버는 kube-system 네임스페이스의 coredns라는 이름의 컨피그맵에 Corefile 설정을 넣어 코어DNS 서버를 구성합니다. p.239

위 말은 coredns라는 이름의 컨피그맵 리소스가 쿠버네티스 어딘가에서 실행 중이라는 것을 의미하고, 이 리소스에 저장된 정보를 확인할 수 있다면 쿠버네티스 내부적으로 관리되는 dns의 원리를 잘 이해할 수 있을 것 같다.

## 액티브 컨트롤러 방식
:제한된 환경에서 외부에 서비스를 노출시키는 방법

(추측) 액티브 컨트롤러란 쿠버네티스 내의 리소스를 외부 서버에 노출 시키는 것?

> 정상적인 상황에서 쿠버네티스 컨트롤러 매니저는 서비스 내의 셀렉터를 기반으로 서비스의 엔드포인트에 정보를 채웁니다. p.239

셀렉터가 있는 경우 적절한 엔드포인트 리소스가 생성되기 때문에 문제가 되지 않는다.

> 그러나 셀렉터가 없는 서비스를 생성하면 선택한 파드가 없으므로, ... 서비스의 엔드포인트 리소스가 만들어지지 않습니다. p.239

셀렉터가 없는 경우 엔드포인트가 자동으로 생성되지 않기 때문에 동적으로 외부 서비스 IP 주소 검색과 엔드포인트 리소스 생성/수정/삭제/조회가 가능하도록 시스템을 구현해야한다.

## 쿠버네티스 서비스 내보내기

내부적으로 서비스를 열어야하는 경우 플란넬과 같은 도구나 기타 네트워킹 공급자 사용을 고려할 수 있다.

## 내부 로드 밸런스를 사용해 서비스 내보내기

> 쿠버네티스에 대한 사전 경험이 있다면 클라우드 기반 로드 밸런서를 연결하여 외부 트래픽을 클러스터의 파드로 가져오는 방법을 이미 알고 있을 겁니다. 그러나 대부분의 클라우드가 내부 로드 밸랜서를 제공한다는 사실까지는 깨닫지 못했을 겁니다. p.241

로드 밸런서를 앞단에 두면(클러스터 외부/내부??) 트래픽을 파드까지 흘려보낼 수 있다.

내부적으로 관리되는 로드 밸런서가 있다고 하는데 가상 IP 주소를 기반으로 맵핑을 할 수 있고, 클라우드 서비스에서 metadate.annotation 기반으로 활성화를 시킬 수 있습니다.
(자세한 사항을 설명해주지 않음)

## 노드 포트로 서비스 내보내기

이전 장에서 살펴보았듯이 노드 포드를 사용하면 외부 클라이언트가 파드로 직접 요청을 보낼 수 있습니다. 따라서 온프레미스 환경에서 쿠버네티스가 실행되고 있는 경우 거미줄 같은 형태로 모든 노드에 리스너를 구현하여 선택한 포트에 트래픽이 흘러들어갈 수 있도록 합니다.

이는 내부 로드 밸런스를 사용하는 것에 비해 커스텀 작업이 많이 일어나고, round robin 방식으로 트래픽을 분산하고자 한다면 추가적인 작업이 많이 일어나야할 것 같다는 생각이 듭니다.



---
### 참고문헌
- 
---
### 연결문서
- 

