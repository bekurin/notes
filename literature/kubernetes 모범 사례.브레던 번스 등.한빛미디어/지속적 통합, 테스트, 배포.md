### 생성 날짜: 2024-03-26T21:41
### 주제: 지속적 통합, 테스트, 배포
---
### 본문:

## 버전 관리
> 쿠버네티스 매니페스트 또는 헬름 차트에는 애플리케이션 코드와 설정 코드가 모두 포함되어 있습니다.

현재 회사에서는 애플리케이션 코드와 헬름 차트 코드가 완전히 분리된 상태에서 실행하고 있고, 모든 코드는 개발자가 관리한다.

## 지속적 통합
> 코드 변경이 커밋 될 때마다 빌드가 실행됩니다. p.101

머지가 아닌 커밋 단위(푸쉬)로 빌드가 실행되도록 하여 미연에 문제를 예방할 수 있도록 한다.

## 테스트
> 테스트를 싱행하는 이유는 코드 변경으로 빌드가 실패할 때 빠르게 피드백을 받기 위해서입니다. p.101

올바른 피드백을 빠르게 받기 위해서는 필요한 테스트를 잘 작성할 수 있는 능력이 뒷받침 되어야한다.

> 헬름에는 helm lint 라는 도구가 있는데, 차트의 잠재적인 문제를 조사하기 위해 일련의 테스트를 수행한다. p.101

헬름 차트에도 github action을 추가하여 문법을 검사하는 것이 좋을 것 같다고 생각한다.  문법 검사가 없다면 올바르지 않은 값이 들어가 있는데도 실패를 잡아주지 않아 운영 환경에서 문제가 발생할 수 있다.
ex. values.yaml 파일에 CPUUtilization 값을 설정해주지 않았음에도 HPA에 코드 추가해도 문제로 지적하지 않는다.

> 코드베이스를 테스트하여 운영에 전달하는 것은 팀 단위의 노력이 필요하면 전체적으로 구현해야 합니다. p.101

당연하겠지만 책임을 맡은 서비스가 사용자에게 안전하고, 빠르게 전달할 수 있도록 소프트웨어적으로 노력하는 것이 중요하기 때문에 개발자라는 직업이 생긴 것 같다는 생각이 든다.

## 컨테이너 빌드
- 애플리케이션을 실행할 때 불필요한 의존 관계를 제거합니다.
- 경량 이미지를 사용합니다. alpain-java17
- 불필요한 바이너리와 셸을 제거합니다.

## 컨테이너 이미지 태그
> 운영에 배포한 이미지의 버전을 쉽게 분별하기 위한 이미지 태그 전략을 세우는 것이 중요합니다. 가장 중요한 것 중 하나는 latest를 이미지 태그로 사용하지 않는 것입니다. p.103

latest는 가장 최근 업데이트를 반영한 것으로 docker hub와 같은 곳에서 꽤 많이 사용하지만 저자가 말한 것처럼 latest는 버전이 아니기 때문에 관리가 되지 않습니다. 만약에 latest를 사용하고자 한다면 한번의 배포에 latest와 latest에 대응하는 이미지를 버전으로 표현하여 배포를 해야할 것 같다는 생각이 듭니다.

이미지 태그에 unique를 부여하기 위해서는 자체 buildID 생성 or 깃 해쉬 사용을 고려할 수 있다.

## 지속적 배포
> 스테이지에서는 잘 동작하던 디플로이먼트가 운영으로 옮겨간 후 배포에 실패하는 경우가 많습니다. 이는 환경 사이의 라이브러리와 컴포넌트 버전 차이, 다시 말해 설정 표류 때문입니다. p.104

스테이지와 운영 환경 더 나아가 개발 환경까지 모든 구성이 같게 유지되는 것이 좋은 것 같다. 모든 환경에서 설정이 다르게 구성되면 각각의 환경에서 CI/CD를 실행하는 것이 불필요한 것은 아니지만 뭔가 엇나간 느낌이 든다...

## 배포 전략

### 롤링 업데이트
maxSurge, maxUnavailable 값을 활용하여 특정 개수만큼의 팟을 신규로 생성하고, 삭제하고를 반복한다.

> 데이터베이스 스키마는 애플리케이션의 두 가지 버전 모두를 지원해야합니다. p.106

컬럼 삭제가 필요한 경우 배포 완료 후에 삭제를 해야하고, 컬럼 추가의 경우는 미리 컬럼을 추가해두면 될 것 같다.

롤링 업데이트 과정에서 사용자의 요청이 미쳐 처리되지 못했는데. 팟을 제거해버리면 사용자는 안 좋은 UX를 경험하게 된다.
이를 막기 위해 spring boot에서는 graceful shutdown 옵션을 제공한다.
### 블루/그린 배포
기존 환경과 새로운 환경을 minReplicas만큼(?) 실행하여 한번에 트래픽을 변경한다.
(기존 환경에서 auto scaling 일어나있으면 얼만큼 팟을 미리 실행해둬야하는 것인지?)

> 데이터베이스 마이그레이션이 어려울 수 있습니다. 진행 중인 트랜잭션과 스키마 업데이트의 호환성을 고려해야하기 때문입니다. p.107

현재 B2B에서는 마이그레이션 전용 API를 구축해두고 배포가 완료되면 API를 호출하는 식으로 마이그레이션을 진행하고 있어 블루/그린 배포를 사용해도 저자가 말한 스키마 업데이트 호환성을 고려하지 않아도 된다.

Q: 하이브리드 배포는 무엇인지?
### 카나리 배포
신규 배포로 트래픽을 전환할 비율을 정할 수 있다. 즉, 기존 환경과 새로운 환경을 모두 실행하여 특정 사용자에 한해 트래픽을 흘려 새로운 환경에 대한 사용자의 피드백, 버그를 찾을 수 있다.

Q: 카나리 배포를 잘 활용하면 개발 환경을 잘 구성할 수 있지 않을까??
인그레스에 테스트 환경 uri를 넣어두고, 특정 replicasSet으로 들어갈 수 있도록 한다면??!

> 카나리 배포는 동시에 여러 버전의 애플리케이션을 실행할 때 어려움을 겪습니다. 예를 들어 데이터베이스 스키마는 두 버전의 애플리케이션을 동시에 지원해야 합니다. p.109

데이터베이스 스키마 변경 없이 레거시 코드를 개편하는 것은 위에서 말한 것을 고려하지 않아도 되겠지만 데이터베이스 스키마가 변경된 경우 또는 마이그레이션이 필요한 경우에는 카나리 배포를 활용하는 것이 매우 어렵겠다는 생각이 들었다.

## 운영에서 테스트

> 운영 테스트의 효과를 파악할 수 있는 심층적인 관찰 전략을 마련하는 겁니다. 최종 사용자의 UX에 영향을 미치는 매트릭을 관찰할 수 없다면, 시스템의 복원력을 향상시키기 위한 명확한 지표가 없는 겁니다. P.110

저자가 말한 매트릭 관찰이 중요한 것은 매우 공감하지만 운영 테스트 실패로 인한 다양한 문제를 떠안는 것과 모니터링을 매우 상세하게 하는 것을 두고 생각해보면 운영 테스트를 진행하는 것보다는 모니터링을 잘하자가 더 올바를 것 같다는 생각이 든다.

Q: 카오스 엔지니어링은 무엇인가?

## 이후는 CI/CD 파이프라인 구축 방법으로 생략

---
### 참고문헌
- 
---
### 연결문서
- 

